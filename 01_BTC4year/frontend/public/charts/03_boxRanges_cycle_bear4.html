<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycle 4 - Box Range Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #020617 0%, #0F172A 100%); height: 100vh; padding: 20px; display: flex; flex-direction: column; }
        .container { flex: 1; display: flex; flex-direction: column; max-width: 1400px; width: 100%; margin: 0 auto; min-height: 0; }
        .chart-wrapper { flex: 1; display: flex; flex-direction: column; background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #0F172A 100%); border-radius: 16px; padding: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); min-height: 0; }
        .header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 12px; }
        .header h2 { font-size: 18px; font-weight: 700; color: #F8FAFC; }
        .header p { font-size: 12px; color: #64748B; margin-top: 4px; }
        #chart { flex: 1; margin: 0 -12px; min-height: 0; }
        .footer { flex-shrink: 0; display: flex; justify-content: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.06); font-size: 11px; color: #64748B; }
    </style>
</head>
<body>
    <div class="container">
        <div class="chart-wrapper">
            <div class="header">
                <div>
                    <h2>Cycle 4 (2025.10~) - Box Range Analysis</h2>
                    <p>Rise ≥5.0%, Break &lt;2.0%</p>
                </div>
            </div>

            <div id="chart"></div>
            <div class="footer">Data source: Supabase BTC/USDT OHLCV</div>
        </div>
    </div>
    <script>
        var series = [{"name": "Cycle 4", "data": [{"x": 0, "y": 98.74, "timestamp": "2025.10.06", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 100}, {"x": 1, "y": 96.72, "timestamp": "2025.10.07", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 100}, {"x": 2, "y": 97.12, "timestamp": "2025.10.08", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 100}, {"x": 3, "y": 95.98, "timestamp": "2025.10.09", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 100}, {"x": 4, "y": 81.82, "timestamp": "2025.10.10", "box_id": 1, "box_day": 1, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 5, "y": 87.89, "timestamp": "2025.10.11", "box_id": 1, "box_day": 2, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 6, "y": 87.89, "timestamp": "2025.10.12", "box_id": 1, "box_day": 3, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 7, "y": 91.14, "timestamp": "2025.10.13", "box_id": 1, "box_day": 4, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 8, "y": 88.13, "timestamp": "2025.10.14", "box_id": 1, "box_day": 5, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 9, "y": 88.37, "timestamp": "2025.10.15", "box_id": 1, "box_day": 6, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 10, "y": 86.18, "timestamp": "2025.10.16", "box_id": 1, "box_day": 7, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 11, "y": 83.05, "timestamp": "2025.10.17", "box_id": 1, "box_day": 8, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 12, "y": 85.29, "timestamp": "2025.10.18", "box_id": 1, "box_day": 9, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 13, "y": 85.12, "timestamp": "2025.10.19", "box_id": 1, "box_day": 10, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 14, "y": 86.16, "timestamp": "2025.10.20", "box_id": 1, "box_day": 11, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 15, "y": 86.21, "timestamp": "2025.10.21", "box_id": 1, "box_day": 12, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 16, "y": 85.57, "timestamp": "2025.10.22", "box_id": 1, "box_day": 13, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 17, "y": 86.24, "timestamp": "2025.10.23", "box_id": 1, "box_day": 14, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 18, "y": 88.0, "timestamp": "2025.10.24", "box_id": 1, "box_day": 15, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 19, "y": 88.78, "timestamp": "2025.10.25", "box_id": 1, "box_day": 16, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 20, "y": 89.25, "timestamp": "2025.10.26", "box_id": 1, "box_day": 17, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 21, "y": 91.31, "timestamp": "2025.10.27", "box_id": 1, "box_day": 18, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 100}, {"x": 22, "y": 90.01, "timestamp": "2025.10.28", "box_id": 1, "box_day": 19, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 23, "y": 87.6, "timestamp": "2025.10.29", "box_id": 1, "box_day": 20, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 24, "y": 85.28, "timestamp": "2025.10.30", "box_id": 1, "box_day": 21, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 25, "y": 86.86, "timestamp": "2025.10.31", "box_id": 1, "box_day": 22, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 26, "y": 87.76, "timestamp": "2025.11.01", "box_id": 1, "box_day": 23, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 27, "y": 87.82, "timestamp": "2025.11.02", "box_id": 1, "box_day": 24, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 28, "y": 84.48, "timestamp": "2025.11.03", "box_id": 1, "box_day": 25, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 29, "y": 79.37, "timestamp": "2025.11.04", "box_id": 1, "box_day": 26, "box_duration": 25, "box_low": 81.82, "box_high": 93.38, "prev_high": 93.38}, {"x": 30, "y": 79.39, "timestamp": "2025.11.05", "box_id": 2, "box_day": 1, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 31, "y": 80.46, "timestamp": "2025.11.06", "box_id": 2, "box_day": 2, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 32, "y": 79.63, "timestamp": "2025.11.07", "box_id": 2, "box_day": 3, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 33, "y": 81.39, "timestamp": "2025.11.08", "box_id": 2, "box_day": 4, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 34, "y": 81.34, "timestamp": "2025.11.09", "box_id": 2, "box_day": 5, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 35, "y": 83.64, "timestamp": "2025.11.10", "box_id": 2, "box_day": 6, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 36, "y": 82.21, "timestamp": "2025.11.11", "box_id": 2, "box_day": 7, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 93.38}, {"x": 37, "y": 80.87, "timestamp": "2025.11.12", "box_id": 2, "box_day": 8, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 86.24}, {"x": 38, "y": 78.62, "timestamp": "2025.11.13", "box_id": 2, "box_day": 9, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 86.24}, {"x": 39, "y": 75.42, "timestamp": "2025.11.14", "box_id": 2, "box_day": 10, "box_duration": 9, "box_low": 79.39, "box_high": 86.24, "prev_high": 86.24}, {"x": 40, "y": 75.85, "timestamp": "2025.11.15", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 86.24}, {"x": 41, "y": 74.61, "timestamp": "2025.11.16", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 86.24}, {"x": 42, "y": 73.18, "timestamp": "2025.11.17", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 86.24}, {"x": 43, "y": 71.6, "timestamp": "2025.11.18", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 86.24}, {"x": 44, "y": 71.08, "timestamp": "2025.11.19", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 86.24}, {"x": 45, "y": 69.07, "timestamp": "2025.11.20", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 86.24}, {"x": 46, "y": 64.66, "timestamp": "2025.11.21", "box_id": 3, "box_day": 1, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 47, "y": 66.98, "timestamp": "2025.11.22", "box_id": 3, "box_day": 2, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 48, "y": 67.92, "timestamp": "2025.11.23", "box_id": 3, "box_day": 3, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 49, "y": 68.4, "timestamp": "2025.11.24", "box_id": 3, "box_day": 4, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 50, "y": 69.08, "timestamp": "2025.11.25", "box_id": 3, "box_day": 5, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 51, "y": 69.23, "timestamp": "2025.11.26", "box_id": 3, "box_day": 6, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 52, "y": 72.27, "timestamp": "2025.11.27", "box_id": 3, "box_day": 7, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 53, "y": 72.34, "timestamp": "2025.11.28", "box_id": 3, "box_day": 8, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 54, "y": 72.32, "timestamp": "2025.11.29", "box_id": 3, "box_day": 9, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 55, "y": 72.47, "timestamp": "2025.11.30", "box_id": 3, "box_day": 10, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 56, "y": 67.24, "timestamp": "2025.12.01", "box_id": 3, "box_day": 11, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 57, "y": 69.14, "timestamp": "2025.12.02", "box_id": 3, "box_day": 12, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 58, "y": 72.99, "timestamp": "2025.12.03", "box_id": 3, "box_day": 13, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 59, "y": 72.91, "timestamp": "2025.12.04", "box_id": 3, "box_day": 14, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 60, "y": 70.64, "timestamp": "2025.12.05", "box_id": 3, "box_day": 15, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 61, "y": 71.32, "timestamp": "2025.12.06", "box_id": 3, "box_day": 16, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 62, "y": 70.37, "timestamp": "2025.12.07", "box_id": 3, "box_day": 17, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 63, "y": 71.89, "timestamp": "2025.12.08", "box_id": 3, "box_day": 18, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 64, "y": 71.8, "timestamp": "2025.12.09", "box_id": 3, "box_day": 19, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 65, "y": 73.45, "timestamp": "2025.12.10", "box_id": 3, "box_day": 20, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 66, "y": 71.6, "timestamp": "2025.12.11", "box_id": 3, "box_day": 21, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 67, "y": 71.78, "timestamp": "2025.12.12", "box_id": 3, "box_day": 22, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 68, "y": 72.01, "timestamp": "2025.12.13", "box_id": 3, "box_day": 23, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 69, "y": 70.25, "timestamp": "2025.12.14", "box_id": 3, "box_day": 24, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 70, "y": 68.3, "timestamp": "2025.12.15", "box_id": 3, "box_day": 25, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 71, "y": 68.4, "timestamp": "2025.12.16", "box_id": 3, "box_day": 26, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 72, "y": 68.44, "timestamp": "2025.12.17", "box_id": 3, "box_day": 27, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 73, "y": 67.75, "timestamp": "2025.12.18", "box_id": 3, "box_day": 28, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 74, "y": 68.27, "timestamp": "2025.12.19", "box_id": 3, "box_day": 29, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 75, "y": 70.43, "timestamp": "2025.12.20", "box_id": 3, "box_day": 30, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 76, "y": 70.27, "timestamp": "2025.12.21", "box_id": 3, "box_day": 31, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 77, "y": 70.51, "timestamp": "2025.12.22", "box_id": 3, "box_day": 32, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 78, "y": 69.47, "timestamp": "2025.12.23", "box_id": 3, "box_day": 33, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 79, "y": 69.33, "timestamp": "2025.12.24", "box_id": 3, "box_day": 34, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 80, "y": 69.74, "timestamp": "2025.12.25", "box_id": 3, "box_day": 35, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 81, "y": 69.51, "timestamp": "2025.12.26", "box_id": 3, "box_day": 36, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 82, "y": 69.99, "timestamp": "2025.12.27", "box_id": 3, "box_day": 37, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 83, "y": 70.14, "timestamp": "2025.12.28", "box_id": 3, "box_day": 38, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 84, "y": 69.64, "timestamp": "2025.12.29", "box_id": 3, "box_day": 39, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 85, "y": 69.67, "timestamp": "2025.12.30", "box_id": 3, "box_day": 40, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 86, "y": 69.99, "timestamp": "2025.12.31", "box_id": 3, "box_day": 41, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 87, "y": 70.23, "timestamp": "2026.01.01", "box_id": 3, "box_day": 42, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 88, "y": 70.9, "timestamp": "2026.01.02", "box_id": 3, "box_day": 43, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 89, "y": 71.65, "timestamp": "2026.01.03", "box_id": 3, "box_day": 44, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 90, "y": 72.7, "timestamp": "2026.01.04", "box_id": 3, "box_day": 45, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 91, "y": 73.41, "timestamp": "2026.01.05", "box_id": 3, "box_day": 46, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 92, "y": 73.21, "timestamp": "2026.01.06", "box_id": 3, "box_day": 47, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 93, "y": 72.74, "timestamp": "2026.01.07", "box_id": 3, "box_day": 48, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 94, "y": 71.64, "timestamp": "2026.01.08", "box_id": 3, "box_day": 49, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 95, "y": 71.95, "timestamp": "2026.01.09", "box_id": 3, "box_day": 50, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 96, "y": 72.52, "timestamp": "2026.01.10", "box_id": 3, "box_day": 51, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 97, "y": 72.39, "timestamp": "2026.01.11", "box_id": 3, "box_day": 52, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 98, "y": 72.3, "timestamp": "2026.01.12", "box_id": 3, "box_day": 53, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 99, "y": 73.03, "timestamp": "2026.01.13", "box_id": 3, "box_day": 54, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 100, "y": 75.85, "timestamp": "2026.01.14", "box_id": 3, "box_day": 55, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 86.24}, {"x": 101, "y": 76.32, "timestamp": "2026.01.15", "box_id": 3, "box_day": 56, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 102, "y": 75.64, "timestamp": "2026.01.16", "box_id": 3, "box_day": 57, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 103, "y": 76.23, "timestamp": "2026.01.17", "box_id": 3, "box_day": 58, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 104, "y": 75.1, "timestamp": "2026.01.18", "box_id": 3, "box_day": 59, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 105, "y": 73.73, "timestamp": "2026.01.19", "box_id": 3, "box_day": 60, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 106, "y": 70.51, "timestamp": "2026.01.20", "box_id": 3, "box_day": 61, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 107, "y": 70.0, "timestamp": "2026.01.21", "box_id": 3, "box_day": 62, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 108, "y": 71.01, "timestamp": "2026.01.22", "box_id": 3, "box_day": 63, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 109, "y": 71.06, "timestamp": "2026.01.23", "box_id": 3, "box_day": 64, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 110, "y": 71.53, "timestamp": "2026.01.24", "box_id": 3, "box_day": 65, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 111, "y": 69.05, "timestamp": "2026.01.25", "box_id": 3, "box_day": 66, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 112, "y": 69.4, "timestamp": "2026.01.26", "box_id": 3, "box_day": 67, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 113, "y": 70.03, "timestamp": "2026.01.27", "box_id": 3, "box_day": 68, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 114, "y": 71.26, "timestamp": "2026.01.28", "box_id": 3, "box_day": 69, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 115, "y": 66.89, "timestamp": "2026.01.29", "box_id": 3, "box_day": 70, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 116, "y": 65.07, "timestamp": "2026.01.30", "box_id": 3, "box_day": 71, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 117, "y": 60.74, "timestamp": "2026.01.31", "box_id": 3, "box_day": 72, "box_duration": 71, "box_low": 64.66, "box_high": 78.55, "prev_high": 78.55}, {"x": 118, "y": 60.73, "timestamp": "2026.02.01", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 78.55}, {"x": 119, "y": 59.85, "timestamp": "2026.02.02", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 78.55}, {"x": 120, "y": 58.52, "timestamp": "2026.02.03", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 78.55}, {"x": 121, "y": 57.67, "timestamp": "2026.02.04", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 78.55}, {"x": 122, "y": 50.01, "timestamp": "2026.02.05", "box_id": null, "box_day": null, "box_duration": null, "box_low": null, "box_high": null, "prev_high": 78.55}, {"x": 123, "y": 48.13, "timestamp": "2026.02.06", "box_id": 4, "box_day": 1, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 78.55}, {"x": 124, "y": 53.99, "timestamp": "2026.02.07", "box_id": 4, "box_day": 2, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 78.55}, {"x": 125, "y": 55.26, "timestamp": "2026.02.08", "box_id": 4, "box_day": 3, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 78.55}, {"x": 126, "y": 54.8, "timestamp": "2026.02.09", "box_id": 4, "box_day": 4, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 57.98}, {"x": 127, "y": 54.39, "timestamp": "2026.02.10", "box_id": 4, "box_day": 5, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 57.98}, {"x": 128, "y": 52.75, "timestamp": "2026.02.11", "box_id": 4, "box_day": 6, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 57.98}, {"x": 129, "y": 52.24, "timestamp": "2026.02.12", "box_id": 4, "box_day": 7, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 57.98}, {"x": 130, "y": 53.08, "timestamp": "2026.02.13", "box_id": 4, "box_day": 8, "box_duration": 7, "box_low": 48.13, "box_high": 57.98, "prev_high": 57.98}]}];
        var boxes = [{"Cycle": 4, "Box_ID": 1, "Start_Day": 4, "Start_Timestamp": "2025/10/10", "Start_Rate": 81.82, "Peak_Day": 21, "Peak_Timestamp": "2025/10/27", "Peak_Rate": 93.38, "End_Day": 29, "End_Timestamp": "2025/11/04", "End_Rate": 79.37, "Rise_Percent": 11.55, "Duration_Days": 25, "Box_Broken": true, "color": "#3B82F6"}, {"Cycle": 4, "Box_ID": 2, "Start_Day": 30, "Start_Timestamp": "2025/11/05", "Start_Rate": 79.39, "Peak_Day": 36, "Peak_Timestamp": "2025/11/11", "Peak_Rate": 86.24, "End_Day": 39, "End_Timestamp": "2025/11/14", "End_Rate": 75.42, "Rise_Percent": 6.85, "Duration_Days": 9, "Box_Broken": true, "color": "#10B981"}, {"Cycle": 4, "Box_ID": 3, "Start_Day": 46, "Start_Timestamp": "2025/11/21", "Start_Rate": 64.66, "Peak_Day": 100, "Peak_Timestamp": "2026/01/14", "Peak_Rate": 78.55, "End_Day": 117, "End_Timestamp": "2026/01/31", "End_Rate": 60.74, "Rise_Percent": 13.9, "Duration_Days": 71, "Box_Broken": true, "color": "#EF4444"}, {"Cycle": 4, "Box_ID": 4, "Start_Day": 123, "Start_Timestamp": "2026/02/06", "Start_Rate": 48.13, "Peak_Day": 125, "Peak_Timestamp": "2026/02/08", "Peak_Rate": 57.98, "End_Day": 130, "End_Timestamp": "2026/02/13", "End_Rate": 53.08, "Rise_Percent": 9.84, "Duration_Days": 7, "Box_Broken": true, "color": "#F59E0B"}];
        var chartInstance = null;
        
        // 박스 사각형 그리기 함수
        function drawBoxRects(chartContext) {
            if (!chartContext) return;
            
            var chartEl = chartContext.el;
            var gridRect = chartEl.querySelector('.apexcharts-grid');
            if (!gridRect) return;
            
            // 기존 박스 rect 제거
            var oldRects = chartEl.querySelectorAll('.box-rect-group');
            oldRects.forEach(function(el) { el.remove(); });
            
            // 새 그룹 생성
            var rectGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            rectGroup.setAttribute('class', 'box-rect-group');
            
            var w = chartContext.w;
            
            // X축, Y축 config에서 고정값 사용
            var xMin = w.config.xaxis.min !== undefined ? w.config.xaxis.min : 0;
            var xMax = w.config.xaxis.max !== undefined ? w.config.xaxis.max : 420;
            var yMin = w.config.yaxis[0].min !== undefined ? w.config.yaxis[0].min : 0;
            var yMax = w.config.yaxis[0].max !== undefined ? w.config.yaxis[0].max : 100;
            
            // 실제 그리드 영역 계산 (SVG 요소에서 직접)
            var gridBBox = gridRect.getBBox();
            var gridX = gridBBox.x;
            var gridY = gridBBox.y;
            var gridWidth = gridBBox.width;
            var gridHeight = gridBBox.height;
            
            boxes.forEach(function(box) {
                // X 좌표 계산 (Start_Day ~ End_Day)
                var x1 = gridX + ((box.Start_Day - xMin) / (xMax - xMin)) * gridWidth;
                var x2 = gridX + ((box.End_Day - xMin) / (xMax - xMin)) * gridWidth;
                
                // Y 좌표 계산 (저점 Start_Rate ~ 고점 Peak_Rate, Y축 반전)
                var yTop = gridY + ((yMax - box.Peak_Rate) / (yMax - yMin)) * gridHeight;
                var yBottom = gridY + ((yMax - box.Start_Rate) / (yMax - yMin)) * gridHeight;
                
                var rectWidth = Math.abs(x2 - x1);
                var rectHeight = Math.abs(yBottom - yTop);
                var rectX = Math.min(x1, x2);
                var rectY = Math.min(yTop, yBottom);
                
                // 화면 범위 체크
                if (rectWidth > 0 && rectHeight > 0) {
                    var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', rectX);
                    rect.setAttribute('y', rectY);
                    rect.setAttribute('width', rectWidth);
                    rect.setAttribute('height', rectHeight);
                    rect.setAttribute('fill', box.color);
                    rect.setAttribute('fill-opacity', '0.15');
                    rect.setAttribute('stroke', box.color);
                    rect.setAttribute('stroke-width', '1.5');
                    rect.setAttribute('stroke-opacity', '0.8');
                    rectGroup.appendChild(rect);
                }
            });
            
            // grid 뒤에 삽입
            if (gridRect && gridRect.parentNode) {
                gridRect.parentNode.insertBefore(rectGroup, gridRect);
            }
        }

        // point annotations (저점/고점 마커)
        var pointAnnotations = [];
        var highColor = '#F87171';
        var lowColor = '#34D399';
        
        boxes.forEach(function(box, idx) {
            // 전고점 찾기 (이전 박스의 고점, L1이면 100% 기준)
            var prevHigh = idx > 0 ? boxes[idx - 1].Peak_Rate : 100;
            var dropFromPrevHigh = ((box.Start_Rate - prevHigh) / prevHigh * 100).toFixed(0);
            
            // 저점 대비 상승률
            var riseFromLow = ((box.Peak_Rate - box.Start_Rate) / box.Start_Rate * 100).toFixed(0);
            
            // 저점 마커
            pointAnnotations.push({
                x: box.Start_Day,
                y: box.Start_Rate,
                marker: { size: 5, fillColor: lowColor, strokeColor: '#fff', strokeWidth: 1 },
                label: { 
                    borderColor: 'transparent', 
                    style: { color: '#065F46', background: '#A7F3D0', fontSize: '9px', padding: { left: 4, right: 4, top: 1, bottom: 1 } }, 
                    text: 'L' + box.Box_ID + ' ' + box.Start_Rate + '% 전고점:' + dropFromPrevHigh + '%', 
                    offsetY: 38,
                    position: 'bottom'
                }
            });
            
            // 고점 마커
            pointAnnotations.push({
                x: box.Peak_Day,
                y: box.Peak_Rate,
                marker: { size: 5, fillColor: highColor, strokeColor: '#fff', strokeWidth: 1, shape: 'triangle' },
                label: { 
                    borderColor: 'transparent', 
                    style: { color: '#991B1B', background: '#FECACA', fontSize: '9px', padding: { left: 4, right: 4, top: 1, bottom: 1 } }, 
                    text: 'H' + box.Box_ID + ' ' + box.Peak_Rate + '% 저점:+' + riseFromLow + '%', 
                    offsetY: -8 
                }
            });
        });

        var options = {
            chart: { 
                type: 'line', 
                height: '100%', 
                fontFamily: "'JetBrains Mono', monospace", 
                background: 'transparent', 
                toolbar: { show: true }, 
                zoom: { enabled: true, type: 'xy' },
                events: {
                    mounted: function(chartContext, config) {
                        chartInstance = chartContext;
                        setTimeout(function() { drawBoxRects(chartContext); }, 100);
                    },
                    updated: function(chartContext, config) {
                        setTimeout(function() { drawBoxRects(chartContext); }, 50);
                    },
                    zoomed: function(chartContext, config) {
                        setTimeout(function() { drawBoxRects(chartContext); }, 50);
                    },
                    beforeResetZoom: function(chartContext, config) {
                        setTimeout(function() { drawBoxRects(chartContext); }, 100);
                        return config;
                    },
                    animationEnd: function(chartContext, config) {
                        drawBoxRects(chartContext);
                    },
                    selection: function(chartContext, config) {
                        setTimeout(function() { drawBoxRects(chartContext); }, 50);
                    }
                }
            },
            series: series,
            colors: ['#3B82F6'],
            stroke: { curve: 'smooth', width: 2 },
            grid: { borderColor: 'rgba(255,255,255,0.08)', strokeDashArray: 4 },
            xaxis: { type: 'numeric', min: 0, max: 420, tickAmount: 14, title: { text: 'Days Since Peak', style: { color: '#94A3B8' } }, labels: { style: { colors: '#94A3B8' } } },
            yaxis: { min: 0, max: 100, tickAmount: 10, title: { text: 'Rate (% of Peak)', style: { color: '#94A3B8' } }, labels: { style: { colors: '#94A3B8' }, formatter: function(v) { return v + '%'; } } },
            tooltip: { 
                theme: 'dark',
                custom: function({ series, seriesIndex, dataPointIndex, w }) {
                    var data = w.config.series[seriesIndex].data[dataPointIndex];
                    var day = data.x;
                    var rate = data.y;
                    var dateStr = data.timestamp;
                    var boxDay = data.box_day;
                    var boxDuration = data.box_duration;
                    var boxLow = data.box_low;
                    var boxHigh = data.box_high;
                    var prevHigh = data.prev_high;
                    
                    var header = 'Cycle 4 : ' + dateStr + ' (' + rate.toFixed(2) + '%)';
                    var line2 = '';
                    
                    if (boxDuration !== null && boxLow !== null && boxHigh !== null && boxDay !== null) {
                        // 박스 내부
                        var distToLow = Math.abs(rate - boxLow);
                        var distToHigh = Math.abs(rate - boxHigh);
                        
                        if (distToLow <= distToHigh) {
                            var pctFromLow = ((rate - boxLow) / boxLow * 100).toFixed(0);
                            var sign = pctFromLow >= 0 ? '+' : '';
                            line2 = day + 'd 박스(' + boxDay + '/' + boxDuration + 'd) 저점대비:' + sign + pctFromLow + '%';
                        } else {
                            var pctFromHigh = ((rate - boxHigh) / boxHigh * 100).toFixed(0);
                            var sign = pctFromHigh >= 0 ? '+' : '';
                            line2 = day + 'd 박스(' + boxDay + '/' + boxDuration + 'd) 고점대비:' + sign + pctFromHigh + '%';
                        }
                    } else {
                        // 박스 외부
                        var pctFromPrevHigh = ((rate - prevHigh) / prevHigh * 100).toFixed(0);
                        var sign = pctFromPrevHigh >= 0 ? '+' : '';
                        line2 = day + 'd 전고점대비:' + sign + pctFromPrevHigh + '%';
                    }
                    
                    return '<div class="apexcharts-tooltip-title" style="font-family:JetBrains Mono,monospace;font-size:12px;">● ' + header + '</div>' +
                        '<div class="apexcharts-tooltip-series-group apexcharts-active" style="display:flex;padding:6px 10px;">' +
                        '<div class="apexcharts-tooltip-text" style="font-family:JetBrains Mono,monospace;font-size:12px;">' +
                        '<span class="apexcharts-tooltip-text-y-value">' + line2 + '</span>' +
                        '</div></div>';
                }
            },
            annotations: { points: pointAnnotations },
            legend: { show: false }
        };

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
        
        // 홈 버튼 클릭 감지 (toolbar 버튼 클릭 시 박스 다시 그리기)
        setTimeout(function() {
            var toolbar = document.querySelector('.apexcharts-toolbar');
            if (toolbar) {
                toolbar.addEventListener('click', function(e) {
                    // 홈 버튼 또는 다른 툴바 버튼 클릭 시
                    setTimeout(function() {
                        if (chartInstance) drawBoxRects(chartInstance);
                    }, 300);
                });
            }
            
            // MutationObserver로 차트 변경 감지
            var chartEl = document.querySelector('#chart');
            var observer = new MutationObserver(function(mutations) {
                if (chartInstance) {
                    setTimeout(function() { drawBoxRects(chartInstance); }, 50);
                }
            });
            observer.observe(chartEl, { childList: true, subtree: true });
        }, 500);
    </script>
</body>
</html>